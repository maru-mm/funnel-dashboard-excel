'use client';

import { useState, useRef, useEffect, useCallback } from 'react';
import Header from '@/components/Header';
import type {
  AffiliateBrowserJob,
  AffiliateChatMessage,
} from '@/types';
import { AFFILIATE_JOB_FINISHED_STATUSES } from '@/types';
import {
  AFFILIATE_PROMPT_TEMPLATES,
  PROMPT_CATEGORIES,
  type AffiliatePromptTemplate,
  type PromptCategory,
} from '@/lib/affiliate-prompt-templates';
import type { ScheduledBrowserJob } from '@/types/database';
import {
  Send,
  Loader2,
  CheckCircle,
  XCircle,
  ExternalLink,
  Bot,
  User,
  AlertCircle,
  StopCircle,
  Globe,
  Zap,
  Eye,
  Clock,
  Activity,
  Wifi,
  WifiOff,
  Copy,
  RotateCcw,
  Settings2,
  ChevronDown,
  ChevronUp,
  MessageSquare,
  Save,
  Database,
  Tag,
  Search,
  TrendingUp,
  Target,
  FileText,
  Play,
  Pause,
  CalendarClock,
  Trash2,
  Sparkles,
  LayoutGrid,
  List,
  X,
  Timer,
  Power,
  PowerOff,
} from 'lucide-react';

// =====================================================
// HELPERS
// =====================================================

function generateId() {
  return Math.random().toString(36).slice(2, 10) + Date.now().toString(36);
}

function formatStatus(status: string): { label: string; color: string; icon: React.ReactNode } {
  switch (status) {
    case 'queued':
      return { label: 'In coda', color: 'bg-gray-100 text-gray-700', icon: <Clock className="w-3.5 h-3.5" /> };
    case 'starting':
      return { label: 'Avvio browser...', color: 'bg-yellow-100 text-yellow-700', icon: <Loader2 className="w-3.5 h-3.5 animate-spin" /> };
    case 'running':
      return { label: 'In esecuzione', color: 'bg-blue-100 text-blue-700', icon: <Loader2 className="w-3.5 h-3.5 animate-spin" /> };
    case 'completed':
      return { label: 'Completato', color: 'bg-green-100 text-green-700', icon: <CheckCircle className="w-3.5 h-3.5" /> };
    case 'max_turns':
      return { label: 'Max turni raggiunto', color: 'bg-orange-100 text-orange-700', icon: <AlertCircle className="w-3.5 h-3.5" /> };
    case 'blocked':
      return { label: 'Bloccato', color: 'bg-red-100 text-red-700', icon: <XCircle className="w-3.5 h-3.5" /> };
    case 'error':
      return { label: 'Errore', color: 'bg-red-100 text-red-700', icon: <XCircle className="w-3.5 h-3.5" /> };
    default:
      return { label: status, color: 'bg-gray-100 text-gray-700', icon: <Activity className="w-3.5 h-3.5" /> };
  }
}

function timeAgo(dateStr: string): string {
  const diff = Date.now() - new Date(dateStr).getTime();
  const s = Math.floor(diff / 1000);
  if (s < 60) return `${s}s fa`;
  const m = Math.floor(s / 60);
  if (m < 60) return `${m}m fa`;
  return `${Math.floor(m / 60)}h fa`;
}

function getCategoryIcon(category: PromptCategory) {
  switch (category) {
    case 'spy_ads': return <Search className="w-4 h-4" />;
    case 'competitor_analysis': return <Target className="w-4 h-4" />;
    case 'trends': return <TrendingUp className="w-4 h-4" />;
    case 'funnel_analysis': return <Eye className="w-4 h-4" />;
    case 'content_research': return <FileText className="w-4 h-4" />;
    case 'offer_discovery': return <Sparkles className="w-4 h-4" />;
    default: return <Zap className="w-4 h-4" />;
  }
}

function formatFrequency(freq: string): string {
  switch (freq) {
    case 'daily': return 'Giornaliero';
    case 'weekly': return 'Settimanale';
    case 'bi_weekly': return 'Ogni 2 settimane';
    case 'monthly': return 'Mensile';
    default: return freq;
  }
}

// =====================================================
// TABS
// =====================================================
type TabId = 'chat' | 'templates' | 'scheduled';

// =====================================================
// MAIN PAGE
// =====================================================

export default function AffiliateBrowserChatPage() {
  // --- Tab ---
  const [activeTab, setActiveTab] = useState<TabId>('chat');

  // --- Chat State ---
  const [prompt, setPrompt] = useState('');
  const [startUrl, setStartUrl] = useState('');
  const [maxTurns, setMaxTurns] = useState(100);
  const [showSettings, setShowSettings] = useState(false);

  const [messages, setMessages] = useState<AffiliateChatMessage[]>([]);
  const [job, setJob] = useState<AffiliateBrowserJob | null>(null);
  const [jobId, setJobId] = useState<string | null>(null);
  const [isRunning, setIsRunning] = useState(false);

  const [serverOnline, setServerOnline] = useState<boolean | null>(null);
  const [isSaving, setIsSaving] = useState(false);

  const pollingRef = useRef<ReturnType<typeof setInterval> | null>(null);
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const inputRef = useRef<HTMLTextAreaElement>(null);

  // --- Template State ---
  const [selectedCategory, setSelectedCategory] = useState<PromptCategory | 'all'>('all');
  const [templateSearch, setTemplateSearch] = useState('');

  // --- Schedule State ---
  const [scheduledJobs, setScheduledJobs] = useState<ScheduledBrowserJob[]>([]);
  const [loadingScheduled, setLoadingScheduled] = useState(false);
  const [scheduleModalOpen, setScheduleModalOpen] = useState(false);
  const [scheduleTemplate, setScheduleTemplate] = useState<AffiliatePromptTemplate | null>(null);
  const [scheduleFrequency, setScheduleFrequency] = useState<string>('daily');
  const [schedulingInProgress, setSchedulingInProgress] = useState(false);

  // --- Auto-scroll chat ---
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages]);

  // --- Health check on mount ---
  useEffect(() => {
    checkHealth();
  }, []);

  // --- Load scheduled jobs when tab changes ---
  useEffect(() => {
    if (activeTab === 'scheduled') {
      loadScheduledJobs();
    }
  }, [activeTab]);

  const checkHealth = async () => {
    try {
      const res = await fetch('/api/affiliate-browser-chat/health');
      const data = await res.json();
      setServerOnline(data.success && data.agenticServer === 'online');
    } catch {
      setServerOnline(false);
    }
  };

  const loadScheduledJobs = async () => {
    setLoadingScheduled(true);
    try {
      const res = await fetch('/api/scheduled-jobs');
      const data = await res.json();
      if (data.success) {
        setScheduledJobs(data.jobs);
      }
    } catch {
      // ignore
    } finally {
      setLoadingScheduled(false);
    }
  };

  // --- Add message ---
  const addMessage = useCallback((role: AffiliateChatMessage['role'], content: string, turnNumber?: number) => {
    setMessages((prev) => [
      ...prev,
      {
        id: generateId(),
        role,
        content,
        timestamp: new Date(),
        turnNumber,
      },
    ]);
  }, []);

  // --- Stop polling ---
  const stopPolling = useCallback(() => {
    if (pollingRef.current) {
      clearInterval(pollingRef.current);
      pollingRef.current = null;
    }
  }, []);

  // --- Start agent ---
  const startAgent = async (customPrompt?: string, customStartUrl?: string, customMaxTurns?: number) => {
    const trimmedPrompt = (customPrompt || prompt).trim();
    if (!trimmedPrompt) return;

    const effectiveStartUrl = customStartUrl ?? startUrl;
    const effectiveMaxTurns = customMaxTurns ?? maxTurns;

    setActiveTab('chat');
    setIsRunning(true);
    setJob(null);
    setJobId(null);

    addMessage('user', trimmedPrompt);
    if (!customPrompt) setPrompt('');

    const urlLabel = effectiveStartUrl.trim() ? effectiveStartUrl.trim() : 'Google (default)';
    addMessage('system', `Avvio agente browser su ${urlLabel} con max ${effectiveMaxTurns} turni...`);

    try {
      const res = await fetch('/api/affiliate-browser-chat/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          prompt: trimmedPrompt,
          startUrl: effectiveStartUrl.trim() || undefined,
          maxTurns: effectiveMaxTurns,
        }),
      });

      const data = await res.json();

      if (!data.success) {
        addMessage('system', `Errore: ${data.error}`);
        setIsRunning(false);
        return;
      }

      setJobId(data.jobId);
      addMessage('system', `Job avviato (${data.jobId.slice(0, 8)}...). Monitoraggio in corso...`);

      startPolling(data.jobId);
    } catch (err) {
      const msg = err instanceof Error ? err.message : 'Errore di rete';
      addMessage('system', `Errore connessione: ${msg}`);
      setIsRunning(false);
    }
  };

  // --- Use template ---
  const useTemplate = (template: AffiliatePromptTemplate) => {
    setPrompt(template.prompt);
    setStartUrl(template.startUrl);
    setMaxTurns(template.maxTurns);
    setActiveTab('chat');
    inputRef.current?.focus();
  };

  // --- Run template immediately ---
  const runTemplateNow = (template: AffiliatePromptTemplate) => {
    startAgent(template.prompt, template.startUrl, template.maxTurns);
  };

  // --- Schedule a template ---
  const openScheduleModal = (template: AffiliatePromptTemplate) => {
    setScheduleTemplate(template);
    setScheduleFrequency(template.suggestedFrequency || 'daily');
    setScheduleModalOpen(true);
  };

  const confirmSchedule = async () => {
    if (!scheduleTemplate) return;
    setSchedulingInProgress(true);

    try {
      const res = await fetch('/api/scheduled-jobs', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          templateId: scheduleTemplate.id,
          title: scheduleTemplate.title,
          prompt: scheduleTemplate.prompt,
          startUrl: scheduleTemplate.startUrl || null,
          maxTurns: scheduleTemplate.maxTurns,
          category: scheduleTemplate.category,
          tags: scheduleTemplate.tags,
          frequency: scheduleFrequency,
        }),
      });

      const data = await res.json();
      if (data.success) {
        setScheduleModalOpen(false);
        setScheduleTemplate(null);
        // Refresh scheduled list
        loadScheduledJobs();
        // Switch to scheduled tab to show confirmation
        setActiveTab('scheduled');
      }
    } catch {
      // ignore
    } finally {
      setSchedulingInProgress(false);
    }
  };

  // --- Toggle scheduled job ---
  const toggleJob = async (jobItem: ScheduledBrowserJob) => {
    try {
      await fetch('/api/scheduled-jobs', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          id: jobItem.id,
          action: 'toggle',
          isActive: !jobItem.is_active,
        }),
      });
      loadScheduledJobs();
    } catch {
      // ignore
    }
  };

  // --- Delete scheduled job ---
  const deleteJob = async (id: string) => {
    try {
      await fetch(`/api/scheduled-jobs?id=${id}`, { method: 'DELETE' });
      loadScheduledJobs();
    } catch {
      // ignore
    }
  };

  // --- Polling ---
  const startPolling = (id: string) => {
    stopPolling();

    let lastText = '';
    let lastTurn = 0;

    pollingRef.current = setInterval(async () => {
      try {
        const res = await fetch(`/api/affiliate-browser-chat/status?jobId=${id}`);
        const data = await res.json();

        if (!data.success) return;

        const j: AffiliateBrowserJob = data.job;
        setJob(j);

        if (j.lastText && j.lastText !== lastText) {
          lastText = j.lastText;
          setMessages((prev) => {
            const filtered = prev.filter(
              (m) => !(m.role === 'agent' && m.id === 'agent-thinking'),
            );
            return [
              ...filtered,
              {
                id: 'agent-thinking',
                role: 'agent' as const,
                content: j.lastText,
                timestamp: new Date(),
                turnNumber: j.currentTurn,
              },
            ];
          });
        }

        if (j.currentTurn > lastTurn) {
          lastTurn = j.currentTurn;
        }

        if (AFFILIATE_JOB_FINISHED_STATUSES.includes(j.status)) {
          stopPolling();
          setIsRunning(false);

          setMessages((prev) => prev.filter((m) => m.id !== 'agent-thinking'));

          if (j.result) {
            addMessage('agent', j.result);
          }
          if (j.error) {
            addMessage('system', `Errore: ${j.error}`);
          }
          if (j.status === 'max_turns') {
            addMessage('system', `L'agente ha raggiunto il limite di ${j.maxTurns} turni. Il risultato potrebbe essere parziale.`);
          }
          if (j.status === 'blocked') {
            addMessage('system', 'Azione bloccata dal sistema di sicurezza.');
          }
        }
      } catch {
        // Network error during polling — keep trying
      }
    }, 3000);
  };

  // --- Stop agent ---
  const stopAgent = () => {
    stopPolling();
    setIsRunning(false);
    addMessage('system', 'Monitoraggio fermato dall\'utente.');
    if (jobId) {
      fetch(`/api/affiliate-browser-chat/stop?jobId=${jobId}`, { method: 'DELETE' }).catch(() => {});
    }
  };

  // --- Copy result ---
  const copyResult = () => {
    const agentMessages = messages.filter((m) => m.role === 'agent' && m.id !== 'agent-thinking');
    const lastAgent = agentMessages[agentMessages.length - 1];
    if (lastAgent) {
      navigator.clipboard.writeText(lastAgent.content);
    }
  };

  // --- Detect save commands ---
  const parseSaveCommand = (text: string): { isSave: boolean; saveType: 'quiz' | 'funnel' } | null => {
    const lower = text.trim().toLowerCase();
    if (/^salva\s+quiz/.test(lower)) return { isSave: true, saveType: 'quiz' };
    if (/^salva\s+funnel/.test(lower)) return { isSave: true, saveType: 'funnel' };
    if (/^save\s+quiz/.test(lower)) return { isSave: true, saveType: 'quiz' };
    if (/^save\s+funnel/.test(lower)) return { isSave: true, saveType: 'funnel' };
    return null;
  };

  // --- Get last agent result ---
  const getLastAgentResult = (): string | null => {
    const agentMessages = messages.filter((m) => m.role === 'agent' && m.id !== 'agent-thinking');
    const lastAgent = agentMessages[agentMessages.length - 1];
    return lastAgent?.content ?? null;
  };

  // --- Save funnel via Claude ---
  const saveFunnel = async (saveType: 'quiz' | 'funnel') => {
    const agentResult = getLastAgentResult();
    if (!agentResult) {
      addMessage('system', 'Nessun risultato dell\'agente disponibile da salvare. Esegui prima un\'analisi.');
      return;
    }

    setIsSaving(true);
    const typeLabel = saveType === 'quiz' ? 'Quiz Funnel' : 'Funnel';
    addMessage('system', `Analisi del risultato con Claude AI per salvare come ${typeLabel}...`);

    try {
      const res = await fetch('/api/affiliate-browser-chat/save-funnel', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          agentResult,
          jobId: jobId || undefined,
          saveType,
        }),
      });

      const data = await res.json();

      if (!data.success) {
        addMessage('system', `Errore salvataggio: ${data.error}`);
        setIsSaving(false);
        return;
      }

      const f = data.funnel;
      const savedMsg = [
        `Funnel salvato con successo!`,
        ``,
        `Nome: ${f.funnel_name}`,
        f.brand_name ? `Brand: ${f.brand_name}` : null,
        `Tipo: ${f.funnel_type}`,
        `Categoria: ${f.category}`,
        `Step totali: ${f.total_steps}`,
        f.tags?.length > 0 ? `Tag: ${f.tags.join(', ')}` : null,
        ``,
        f.analysis_summary ? `Analisi: ${f.analysis_summary}` : null,
      ].filter(Boolean).join('\n');

      addMessage('agent', savedMsg);
    } catch (err) {
      const msg = err instanceof Error ? err.message : 'Errore di rete';
      addMessage('system', `Errore connessione durante il salvataggio: ${msg}`);
    } finally {
      setIsSaving(false);
    }
  };

  // --- Handle submit (agent or save command) ---
  const handleSubmit = () => {
    const trimmedPrompt = prompt.trim();
    if (!trimmedPrompt) return;

    const saveCmd = parseSaveCommand(trimmedPrompt);
    if (saveCmd) {
      addMessage('user', trimmedPrompt);
      setPrompt('');
      saveFunnel(saveCmd.saveType);
    } else {
      startAgent();
    }
  };

  // --- Handle Enter ---
  const handleKeyDown = (e: React.KeyboardEvent<HTMLTextAreaElement>) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      if (!isRunning && !isSaving && prompt.trim()) {
        handleSubmit();
      }
    }
  };

  // --- Cleanup ---
  useEffect(() => {
    return () => stopPolling();
  }, [stopPolling]);

  // --- Filter templates ---
  const filteredTemplates = AFFILIATE_PROMPT_TEMPLATES.filter((t) => {
    const matchCategory = selectedCategory === 'all' || t.category === selectedCategory;
    const matchSearch = !templateSearch || 
      t.title.toLowerCase().includes(templateSearch.toLowerCase()) ||
      t.description.toLowerCase().includes(templateSearch.toLowerCase()) ||
      t.tags.some(tag => tag.toLowerCase().includes(templateSearch.toLowerCase()));
    return matchCategory && matchSearch;
  });

  // --- Render ---
  return (
    <div className="min-h-screen bg-gray-50 flex flex-col">
      <Header
        title="Affiliate Browser Chat"
        subtitle="Prompt templates, browser agent e job schedulati per il mondo affiliate"
      />

      <div className="flex-1 flex flex-col p-6 max-w-6xl mx-auto w-full">
        {/* Server status bar */}
        <div className="flex items-center justify-between mb-4">
          <div className="flex items-center gap-2">
            {serverOnline === null ? (
              <span className="flex items-center gap-1.5 text-xs text-gray-400">
                <Loader2 className="w-3 h-3 animate-spin" /> Verifica server...
              </span>
            ) : serverOnline ? (
              <span className="flex items-center gap-1.5 text-xs text-green-600">
                <Wifi className="w-3 h-3" /> Server agentico online
              </span>
            ) : (
              <span className="flex items-center gap-1.5 text-xs text-red-500">
                <WifiOff className="w-3 h-3" /> Server agentico offline
              </span>
            )}
            <button
              onClick={checkHealth}
              className="text-xs text-gray-400 hover:text-gray-600 transition-colors"
              title="Ricontrolla"
            >
              <RotateCcw className="w-3 h-3" />
            </button>
          </div>

          <button
            onClick={() => setShowSettings(!showSettings)}
            className="flex items-center gap-1.5 text-xs text-gray-500 hover:text-gray-700 transition-colors"
          >
            <Settings2 className="w-3.5 h-3.5" />
            Impostazioni
            {showSettings ? <ChevronUp className="w-3 h-3" /> : <ChevronDown className="w-3 h-3" />}
          </button>
        </div>

        {/* Settings panel */}
        {showSettings && (
          <div className="bg-white rounded-lg border border-gray-200 p-4 mb-4 shadow-sm">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">URL di partenza</label>
                <input
                  type="url"
                  value={startUrl}
                  onChange={(e) => setStartUrl(e.target.value)}
                  placeholder="https://esempio.com (opzionale)"
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                />
                <p className="text-xs text-gray-400 mt-1">Se vuoto, parte da Google</p>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Max turni agente</label>
                <div className="flex items-center gap-3">
                  <input
                    type="range"
                    min={5}
                    max={500}
                    step={5}
                    value={maxTurns}
                    onChange={(e) => setMaxTurns(Number(e.target.value))}
                    className="flex-1"
                  />
                  <span className="text-sm font-mono bg-gray-100 px-2 py-1 rounded min-w-[3rem] text-center">
                    {maxTurns}
                  </span>
                </div>
                <p className="text-xs text-gray-400 mt-1">Piu turni = navigazione piu profonda (5-15 min per 100 turni)</p>
              </div>
            </div>
          </div>
        )}

        {/* Tab navigation */}
        <div className="flex items-center gap-1 mb-4 bg-white rounded-lg border border-gray-200 p-1 shadow-sm">
          <button
            onClick={() => setActiveTab('chat')}
            className={`flex items-center gap-2 px-4 py-2.5 rounded-md text-sm font-medium transition-all ${
              activeTab === 'chat'
                ? 'bg-blue-600 text-white shadow-sm'
                : 'text-gray-600 hover:text-gray-800 hover:bg-gray-50'
            }`}
          >
            <MessageSquare className="w-4 h-4" />
            Chat
            {isRunning && (
              <span className="w-2 h-2 bg-green-400 rounded-full animate-pulse" />
            )}
          </button>
          <button
            onClick={() => setActiveTab('templates')}
            className={`flex items-center gap-2 px-4 py-2.5 rounded-md text-sm font-medium transition-all ${
              activeTab === 'templates'
                ? 'bg-blue-600 text-white shadow-sm'
                : 'text-gray-600 hover:text-gray-800 hover:bg-gray-50'
            }`}
          >
            <LayoutGrid className="w-4 h-4" />
            Prompt Templates
            <span className="text-xs opacity-70">({AFFILIATE_PROMPT_TEMPLATES.length})</span>
          </button>
          <button
            onClick={() => setActiveTab('scheduled')}
            className={`flex items-center gap-2 px-4 py-2.5 rounded-md text-sm font-medium transition-all ${
              activeTab === 'scheduled'
                ? 'bg-blue-600 text-white shadow-sm'
                : 'text-gray-600 hover:text-gray-800 hover:bg-gray-50'
            }`}
          >
            <CalendarClock className="w-4 h-4" />
            Schedulati
            {scheduledJobs.filter(j => j.is_active).length > 0 && (
              <span className={`text-xs px-1.5 py-0.5 rounded-full ${
                activeTab === 'scheduled' ? 'bg-white/20' : 'bg-blue-100 text-blue-700'
              }`}>
                {scheduledJobs.filter(j => j.is_active).length}
              </span>
            )}
          </button>
        </div>

        {/* =================== CHAT TAB =================== */}
        {activeTab === 'chat' && (
          <>
            {/* Live job status panel */}
            {job && isRunning && (
              <JobStatusPanel job={job} />
            )}

            {/* Chat messages */}
            <div className="flex-1 bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden flex flex-col min-h-[500px]">
              <div className="flex-1 overflow-y-auto p-4 space-y-4">
                {messages.length === 0 ? (
                  <EmptyState onSelectTemplate={(t) => useTemplate(t)} />
                ) : (
                  messages.map((msg) => (
                    <ChatBubble key={msg.id} message={msg} />
                  ))
                )}
                <div ref={messagesEndRef} />
              </div>

              {/* Input area */}
              <div className="border-t border-gray-200 p-4 bg-gray-50">
                {!showSettings && startUrl && (
                  <div className="flex items-center gap-2 mb-2">
                    <Globe className="w-3.5 h-3.5 text-gray-400" />
                    <span className="text-xs text-gray-500 truncate">{startUrl}</span>
                    <a
                      href={startUrl}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="text-blue-500 hover:text-blue-700"
                    >
                      <ExternalLink className="w-3 h-3" />
                    </a>
                  </div>
                )}

                <div className="flex items-end gap-3">
                  <textarea
                    ref={inputRef}
                    value={prompt}
                    onChange={(e) => setPrompt(e.target.value)}
                    onKeyDown={handleKeyDown}
                    placeholder={
                      isRunning
                        ? "Agente in esecuzione..."
                        : isSaving
                          ? "Salvataggio in corso..."
                          : "Scrivi il prompt... (o 'Salva Quiz' / 'Salva Funnel' per salvare il risultato)"
                    }
                    disabled={isRunning || isSaving}
                    rows={2}
                    className="flex-1 px-4 py-3 border border-gray-300 rounded-xl resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none disabled:bg-gray-100 disabled:text-gray-400 text-sm"
                  />

                  {isRunning ? (
                    <button
                      onClick={stopAgent}
                      className="flex items-center gap-2 px-5 py-3 bg-red-500 text-white rounded-xl hover:bg-red-600 transition-colors font-medium text-sm shrink-0"
                    >
                      <StopCircle className="w-4 h-4" />
                      Stop
                    </button>
                  ) : isSaving ? (
                    <button
                      disabled
                      className="flex items-center gap-2 px-5 py-3 bg-emerald-500 text-white rounded-xl font-medium text-sm shrink-0 cursor-not-allowed"
                    >
                      <Loader2 className="w-4 h-4 animate-spin" />
                      Salvataggio...
                    </button>
                  ) : (
                    <button
                      onClick={handleSubmit}
                      disabled={!prompt.trim() || (serverOnline === false && !parseSaveCommand(prompt))}
                      className="flex items-center gap-2 px-5 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors font-medium text-sm shrink-0"
                    >
                      {parseSaveCommand(prompt) ? <Save className="w-4 h-4" /> : <Send className="w-4 h-4" />}
                      {parseSaveCommand(prompt) ? 'Salva' : 'Invia'}
                    </button>
                  )}
                </div>

                {/* Action buttons when result available */}
                {!isRunning && !isSaving && messages.some((m) => m.role === 'agent' && m.id !== 'agent-thinking') && (
                  <div className="mt-2 flex items-center gap-3 flex-wrap">
                    <button
                      onClick={copyResult}
                      className="flex items-center gap-1.5 text-xs text-gray-400 hover:text-gray-600 transition-colors"
                    >
                      <Copy className="w-3 h-3" />
                      Copia risultato
                    </button>
                    <span className="text-gray-200">|</span>
                    <button
                      onClick={() => {
                        addMessage('user', 'Salva Quiz');
                        saveFunnel('quiz');
                      }}
                      className="flex items-center gap-1.5 text-xs text-emerald-500 hover:text-emerald-700 transition-colors font-medium"
                    >
                      <Database className="w-3 h-3" />
                      Salva Quiz
                    </button>
                    <button
                      onClick={() => {
                        addMessage('user', 'Salva Funnel');
                        saveFunnel('funnel');
                      }}
                      className="flex items-center gap-1.5 text-xs text-violet-500 hover:text-violet-700 transition-colors font-medium"
                    >
                      <Tag className="w-3 h-3" />
                      Salva Funnel
                    </button>
                  </div>
                )}
              </div>
            </div>
          </>
        )}

        {/* =================== TEMPLATES TAB =================== */}
        {activeTab === 'templates' && (
          <div className="space-y-4">
            {/* Search & filter bar */}
            <div className="flex items-center gap-3 flex-wrap">
              <div className="relative flex-1 min-w-[200px]">
                <Search className="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
                <input
                  type="text"
                  value={templateSearch}
                  onChange={(e) => setTemplateSearch(e.target.value)}
                  placeholder="Cerca template..."
                  className="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none bg-white"
                />
              </div>
              <div className="flex items-center gap-1.5 flex-wrap">
                <button
                  onClick={() => setSelectedCategory('all')}
                  className={`px-3 py-1.5 rounded-full text-xs font-medium transition-all ${
                    selectedCategory === 'all'
                      ? 'bg-gray-900 text-white'
                      : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                  }`}
                >
                  Tutti
                </button>
                {PROMPT_CATEGORIES.map((cat) => (
                  <button
                    key={cat.value}
                    onClick={() => setSelectedCategory(cat.value)}
                    className={`flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium transition-all ${
                      selectedCategory === cat.value
                        ? 'bg-gray-900 text-white'
                        : `${cat.bgColor} ${cat.color} hover:opacity-80`
                    }`}
                  >
                    {getCategoryIcon(cat.value)}
                    {cat.label}
                  </button>
                ))}
              </div>
            </div>

            {/* Templates grid */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {filteredTemplates.map((template) => (
                <TemplateCard
                  key={template.id}
                  template={template}
                  onUse={() => useTemplate(template)}
                  onRun={() => runTemplateNow(template)}
                  onSchedule={() => openScheduleModal(template)}
                  serverOnline={serverOnline === true}
                />
              ))}
            </div>

            {filteredTemplates.length === 0 && (
              <div className="text-center py-12">
                <Search className="w-10 h-10 text-gray-300 mx-auto mb-3" />
                <p className="text-sm text-gray-500">Nessun template trovato</p>
                <p className="text-xs text-gray-400 mt-1">Prova a cambiare i filtri di ricerca</p>
              </div>
            )}
          </div>
        )}

        {/* =================== SCHEDULED TAB =================== */}
        {activeTab === 'scheduled' && (
          <div className="space-y-4">
            {/* Header */}
            <div className="flex items-center justify-between">
              <div>
                <h3 className="text-sm font-semibold text-gray-900">Job Schedulati</h3>
                <p className="text-xs text-gray-500 mt-0.5">
                  I job vengono eseguiti automaticamente tramite il cron endpoint
                </p>
              </div>
              <div className="flex items-center gap-2">
                <button
                  onClick={loadScheduledJobs}
                  className="flex items-center gap-1.5 text-xs text-gray-500 hover:text-gray-700 transition-colors"
                >
                  <RotateCcw className="w-3 h-3" />
                  Aggiorna
                </button>
                <button
                  onClick={() => setActiveTab('templates')}
                  className="flex items-center gap-1.5 px-3 py-1.5 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors"
                >
                  <CalendarClock className="w-3.5 h-3.5" />
                  Schedula nuovo
                </button>
              </div>
            </div>

            {/* Info box about cron */}
            <div className="bg-amber-50 border border-amber-200 rounded-lg p-4">
              <div className="flex items-start gap-3">
                <Timer className="w-5 h-5 text-amber-600 shrink-0 mt-0.5" />
                <div>
                  <p className="text-sm font-medium text-amber-800">Come funziona lo scheduling</p>
                  <p className="text-xs text-amber-700 mt-1 leading-relaxed">
                    I job schedulati vengono eseguiti automaticamente quando il cron endpoint viene chiamato.
                    Puoi configurare un servizio esterno (es. cron-job.org, Upstash, GitHub Actions) per chiamare{' '}
                    <code className="bg-amber-100 px-1 py-0.5 rounded text-[10px] font-mono">GET /api/scheduled-jobs/cron</code>{' '}
                    ad intervalli regolari (es. ogni ora). Il sistema controllerà quali job sono &quot;due&quot; ed li eseguirà.
                  </p>
                </div>
              </div>
            </div>

            {/* Scheduled jobs list */}
            {loadingScheduled ? (
              <div className="flex items-center justify-center py-12">
                <Loader2 className="w-6 h-6 animate-spin text-gray-400" />
              </div>
            ) : scheduledJobs.length === 0 ? (
              <div className="text-center py-12 bg-white rounded-xl border border-gray-200">
                <CalendarClock className="w-10 h-10 text-gray-300 mx-auto mb-3" />
                <p className="text-sm text-gray-500">Nessun job schedulato</p>
                <p className="text-xs text-gray-400 mt-1">
                  Vai ai <button onClick={() => setActiveTab('templates')} className="text-blue-500 hover:underline">Prompt Templates</button> per schedulare un job
                </p>
              </div>
            ) : (
              <div className="space-y-3">
                {scheduledJobs.map((sj) => (
                  <ScheduledJobCard
                    key={sj.id}
                    job={sj}
                    onToggle={() => toggleJob(sj)}
                    onDelete={() => deleteJob(sj.id)}
                    onRunNow={() => {
                      startAgent(sj.prompt, sj.start_url || '', sj.max_turns);
                    }}
                  />
                ))}
              </div>
            )}
          </div>
        )}
      </div>

      {/* =================== SCHEDULE MODAL =================== */}
      {scheduleModalOpen && scheduleTemplate && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div className="p-6">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-semibold text-gray-900">Schedula Job</h3>
                <button
                  onClick={() => setScheduleModalOpen(false)}
                  className="p-1.5 hover:bg-gray-100 rounded-lg transition-colors"
                >
                  <X className="w-5 h-5 text-gray-400" />
                </button>
              </div>

              <div className="space-y-4">
                {/* Template info */}
                <div className="bg-gray-50 rounded-lg p-4 border border-gray-200">
                  <div className="flex items-center gap-2 mb-2">
                    {getCategoryIcon(scheduleTemplate.category)}
                    <span className="text-sm font-medium text-gray-900">{scheduleTemplate.title}</span>
                  </div>
                  <p className="text-xs text-gray-500">{scheduleTemplate.description}</p>
                  <div className="flex items-center gap-2 mt-2">
                    {scheduleTemplate.tags.map((tag) => (
                      <span key={tag} className="px-2 py-0.5 bg-gray-200 text-gray-600 rounded text-[10px]">
                        {tag}
                      </span>
                    ))}
                  </div>
                </div>

                {/* Frequency selection */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Frequenza di esecuzione</label>
                  <div className="grid grid-cols-2 gap-2">
                    {['daily', 'weekly', 'bi_weekly', 'monthly'].map((freq) => (
                      <button
                        key={freq}
                        onClick={() => setScheduleFrequency(freq)}
                        className={`px-4 py-3 rounded-lg border text-sm font-medium transition-all ${
                          scheduleFrequency === freq
                            ? 'border-blue-500 bg-blue-50 text-blue-700'
                            : 'border-gray-200 bg-white text-gray-600 hover:bg-gray-50'
                        }`}
                      >
                        <div className="flex items-center gap-2">
                          <CalendarClock className="w-4 h-4" />
                          {formatFrequency(freq)}
                        </div>
                        {freq === 'daily' && <p className="text-[10px] text-gray-400 mt-1">Ogni giorno alle 6:00 UTC</p>}
                        {freq === 'weekly' && <p className="text-[10px] text-gray-400 mt-1">Ogni 7 giorni</p>}
                        {freq === 'bi_weekly' && <p className="text-[10px] text-gray-400 mt-1">Ogni 14 giorni</p>}
                        {freq === 'monthly' && <p className="text-[10px] text-gray-400 mt-1">Ogni 30 giorni</p>}
                      </button>
                    ))}
                  </div>
                </div>

                {/* Config summary */}
                <div className="bg-blue-50 rounded-lg p-3 border border-blue-200">
                  <p className="text-xs text-blue-700">
                    Il job verrà eseguito <strong>{formatFrequency(scheduleFrequency).toLowerCase()}</strong> con{' '}
                    <strong>{scheduleTemplate.maxTurns} turni max</strong>
                    {scheduleTemplate.startUrl && (
                      <> partendo da <strong>{scheduleTemplate.startUrl}</strong></>
                    )}
                    . La prima esecuzione avverrà al prossimo ciclo del cron.
                  </p>
                </div>

                {/* Actions */}
                <div className="flex items-center gap-3 pt-2">
                  <button
                    onClick={() => setScheduleModalOpen(false)}
                    className="flex-1 px-4 py-2.5 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors"
                  >
                    Annulla
                  </button>
                  <button
                    onClick={confirmSchedule}
                    disabled={schedulingInProgress}
                    className="flex-1 flex items-center justify-center gap-2 px-4 py-2.5 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 disabled:opacity-50 transition-colors"
                  >
                    {schedulingInProgress ? (
                      <Loader2 className="w-4 h-4 animate-spin" />
                    ) : (
                      <CalendarClock className="w-4 h-4" />
                    )}
                    Conferma Schedule
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// =====================================================
// TEMPLATE CARD
// =====================================================

function TemplateCard({
  template,
  onUse,
  onRun,
  onSchedule,
  serverOnline,
}: {
  template: AffiliatePromptTemplate;
  onUse: () => void;
  onRun: () => void;
  onSchedule: () => void;
  serverOnline: boolean;
}) {
  const [expanded, setExpanded] = useState(false);
  const category = PROMPT_CATEGORIES.find((c) => c.value === template.category);

  return (
    <div className="bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow overflow-hidden">
      <div className="p-4">
        {/* Header */}
        <div className="flex items-start justify-between gap-3">
          <div className="flex items-start gap-3">
            <div className={`w-10 h-10 rounded-lg flex items-center justify-center shrink-0 ${category?.bgColor || 'bg-gray-50 border-gray-200'} border`}>
              {getCategoryIcon(template.category)}
            </div>
            <div>
              <h4 className="text-sm font-semibold text-gray-900 leading-tight">{template.title}</h4>
              <p className="text-xs text-gray-500 mt-1 line-clamp-2">{template.description}</p>
            </div>
          </div>
        </div>

        {/* Tags */}
        <div className="flex items-center gap-1.5 mt-3 flex-wrap">
          <span className={`px-2 py-0.5 rounded-full text-[10px] font-medium ${category?.bgColor || 'bg-gray-100'} ${category?.color || 'text-gray-600'}`}>
            {category?.label || template.category}
          </span>
          {template.tags.slice(0, 3).map((tag) => (
            <span key={tag} className="px-2 py-0.5 bg-gray-100 text-gray-500 rounded-full text-[10px]">
              {tag}
            </span>
          ))}
          {template.schedulable && (
            <span className="px-2 py-0.5 bg-amber-50 text-amber-700 border border-amber-200 rounded-full text-[10px] flex items-center gap-1">
              <CalendarClock className="w-2.5 h-2.5" />
              Schedulabile
            </span>
          )}
        </div>

        {/* Expandable prompt preview */}
        <button
          onClick={() => setExpanded(!expanded)}
          className="flex items-center gap-1.5 text-[11px] text-gray-400 hover:text-gray-600 mt-3 transition-colors"
        >
          {expanded ? <ChevronUp className="w-3 h-3" /> : <ChevronDown className="w-3 h-3" />}
          {expanded ? 'Nascondi prompt' : 'Anteprima prompt'}
        </button>

        {expanded && (
          <div className="mt-2 bg-gray-50 rounded-lg p-3 text-xs text-gray-600 whitespace-pre-wrap max-h-[200px] overflow-y-auto border border-gray-100 leading-relaxed">
            {template.prompt}
          </div>
        )}

        {/* Config info */}
        <div className="flex items-center gap-3 mt-3 text-[11px] text-gray-400">
          {template.startUrl && (
            <span className="flex items-center gap-1">
              <Globe className="w-3 h-3" />
              {new URL(template.startUrl).hostname}
            </span>
          )}
          <span className="flex items-center gap-1">
            <Activity className="w-3 h-3" />
            {template.maxTurns} turni max
          </span>
        </div>
      </div>

      {/* Actions footer */}
      <div className="border-t border-gray-100 px-4 py-3 bg-gray-50/50 flex items-center gap-2">
        <button
          onClick={onUse}
          className="flex items-center gap-1.5 px-3 py-1.5 bg-white border border-gray-200 rounded-lg text-xs font-medium text-gray-700 hover:bg-gray-50 transition-colors"
        >
          <FileText className="w-3 h-3" />
          Usa prompt
        </button>
        <button
          onClick={onRun}
          disabled={!serverOnline}
          className="flex items-center gap-1.5 px-3 py-1.5 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
        >
          <Play className="w-3 h-3" />
          Esegui ora
        </button>
        {template.schedulable && (
          <button
            onClick={onSchedule}
            className="flex items-center gap-1.5 px-3 py-1.5 bg-amber-500 text-white rounded-lg text-xs font-medium hover:bg-amber-600 transition-colors ml-auto"
          >
            <CalendarClock className="w-3 h-3" />
            Schedula
          </button>
        )}
      </div>
    </div>
  );
}

// =====================================================
// SCHEDULED JOB CARD
// =====================================================

function ScheduledJobCard({
  job,
  onToggle,
  onDelete,
  onRunNow,
}: {
  job: ScheduledBrowserJob;
  onToggle: () => void;
  onDelete: () => void;
  onRunNow: () => void;
}) {
  const [showDetails, setShowDetails] = useState(false);
  const category = PROMPT_CATEGORIES.find((c) => c.value === job.category);
  const isOverdue = job.is_active && new Date(job.next_run_at) <= new Date();

  return (
    <div className={`bg-white rounded-xl border shadow-sm overflow-hidden transition-all ${
      job.is_active ? 'border-gray-200' : 'border-gray-100 opacity-60'
    }`}>
      <div className="p-4">
        <div className="flex items-center justify-between gap-3">
          <div className="flex items-center gap-3">
            <div className={`w-9 h-9 rounded-lg flex items-center justify-center shrink-0 ${
              job.is_active 
                ? (category?.bgColor || 'bg-gray-50 border-gray-200')
                : 'bg-gray-100 border-gray-200'
            } border`}>
              {getCategoryIcon(job.category as PromptCategory)}
            </div>
            <div>
              <h4 className="text-sm font-semibold text-gray-900">{job.title}</h4>
              <div className="flex items-center gap-2 mt-0.5">
                <span className={`px-2 py-0.5 rounded-full text-[10px] font-medium ${category?.bgColor || 'bg-gray-100'} ${category?.color || 'text-gray-600'}`}>
                  {category?.label || job.category}
                </span>
                <span className="text-[10px] text-gray-400 flex items-center gap-1">
                  <CalendarClock className="w-2.5 h-2.5" />
                  {formatFrequency(job.frequency)}
                </span>
                {isOverdue && (
                  <span className="px-2 py-0.5 bg-red-50 text-red-600 rounded-full text-[10px] font-medium">
                    In attesa di esecuzione
                  </span>
                )}
              </div>
            </div>
          </div>

          <div className="flex items-center gap-1.5">
            <button
              onClick={onRunNow}
              className="p-1.5 hover:bg-blue-50 rounded-lg transition-colors"
              title="Esegui ora"
            >
              <Play className="w-4 h-4 text-blue-500" />
            </button>
            <button
              onClick={onToggle}
              className={`p-1.5 rounded-lg transition-colors ${
                job.is_active ? 'hover:bg-amber-50' : 'hover:bg-green-50'
              }`}
              title={job.is_active ? 'Pausa' : 'Riattiva'}
            >
              {job.is_active ? (
                <Pause className="w-4 h-4 text-amber-500" />
              ) : (
                <Power className="w-4 h-4 text-green-500" />
              )}
            </button>
            <button
              onClick={onDelete}
              className="p-1.5 hover:bg-red-50 rounded-lg transition-colors"
              title="Elimina"
            >
              <Trash2 className="w-4 h-4 text-red-400" />
            </button>
          </div>
        </div>

        {/* Stats */}
        <div className="flex items-center gap-4 mt-3 text-[11px] text-gray-400">
          <span className="flex items-center gap-1">
            <Activity className="w-3 h-3" />
            {job.total_runs} esecuzioni ({job.successful_runs} ok)
          </span>
          {job.last_run_at && (
            <span className="flex items-center gap-1">
              <Clock className="w-3 h-3" />
              Ultimo: {timeAgo(job.last_run_at)}
            </span>
          )}
          <span className="flex items-center gap-1">
            <Timer className="w-3 h-3" />
            Prossimo: {new Date(job.next_run_at).toLocaleDateString('it-IT', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' })}
          </span>
        </div>

        {/* Last status */}
        {job.last_status && (
          <div className="mt-2">
            {job.last_status === 'error' && job.last_error ? (
              <div className="flex items-center gap-1.5 text-[11px] text-red-500">
                <XCircle className="w-3 h-3" />
                Ultimo errore: {job.last_error.slice(0, 100)}
              </div>
            ) : job.last_status === 'completed' || job.last_status === 'running' ? (
              <div className="flex items-center gap-1.5 text-[11px] text-green-500">
                <CheckCircle className="w-3 h-3" />
                Ultimo stato: {job.last_status}
              </div>
            ) : null}
          </div>
        )}

        {/* Expand details */}
        <button
          onClick={() => setShowDetails(!showDetails)}
          className="flex items-center gap-1 text-[10px] text-gray-400 hover:text-gray-600 mt-2 transition-colors"
        >
          {showDetails ? <ChevronUp className="w-2.5 h-2.5" /> : <ChevronDown className="w-2.5 h-2.5" />}
          {showDetails ? 'Nascondi dettagli' : 'Mostra prompt'}
        </button>

        {showDetails && (
          <div className="mt-2 bg-gray-50 rounded-lg p-3 text-xs text-gray-600 whitespace-pre-wrap max-h-[150px] overflow-y-auto border border-gray-100 leading-relaxed">
            {job.prompt}
          </div>
        )}
      </div>
    </div>
  );
}

// =====================================================
// JOB STATUS PANEL (live progress)
// =====================================================

function JobStatusPanel({ job }: { job: AffiliateBrowserJob }) {
  const statusInfo = formatStatus(job.status);
  const progressPct = job.maxTurns > 0 ? Math.max(2, (job.currentTurn / job.maxTurns) * 100) : 0;

  return (
    <div className="bg-white rounded-lg border border-blue-200 shadow-sm p-4 mb-4">
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center gap-3">
          <span className={`flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium ${statusInfo.color}`}>
            {statusInfo.icon}
            {statusInfo.label}
          </span>
          <span className="text-sm text-gray-600 font-medium">
            Turno {job.currentTurn} / {job.maxTurns}
          </span>
        </div>
        <div className="flex items-center gap-2">
          {job.debugUrl && (
            <a
              href={job.debugUrl}
              target="_blank"
              rel="noopener noreferrer"
              className="flex items-center gap-1.5 text-xs text-blue-600 hover:text-blue-800 bg-blue-50 px-3 py-1.5 rounded-lg hover:bg-blue-100 transition-colors"
            >
              <Eye className="w-3.5 h-3.5" />
              Watch Live
            </a>
          )}
          {job.createdAt && (
            <span className="text-xs text-gray-400">
              {timeAgo(job.createdAt)}
            </span>
          )}
        </div>
      </div>

      <div className="w-full bg-gray-200 rounded-full h-2 mb-3">
        <div
          className="bg-blue-500 h-2 rounded-full transition-all duration-700 ease-out"
          style={{ width: `${progressPct}%` }}
        />
      </div>

      {job.currentUrl && (
        <div className="flex items-center gap-2 text-xs text-gray-500">
          <Globe className="w-3 h-3 shrink-0" />
          <span className="truncate">{job.currentUrl}</span>
          <a
            href={job.currentUrl}
            target="_blank"
            rel="noopener noreferrer"
            className="text-blue-500 hover:text-blue-700 shrink-0"
          >
            <ExternalLink className="w-3 h-3" />
          </a>
        </div>
      )}

      {job.lastActions && job.lastActions.length > 0 && (
        <div className="flex items-center gap-2 mt-2">
          <Zap className="w-3 h-3 text-violet-500 shrink-0" />
          <div className="flex gap-1 flex-wrap">
            {job.lastActions.map((action, i) => (
              <span
                key={i}
                className="px-2 py-0.5 bg-violet-50 text-violet-700 rounded text-xs font-mono"
              >
                {action}
              </span>
            ))}
          </div>
        </div>
      )}
    </div>
  );
}

// =====================================================
// CHAT BUBBLE
// =====================================================

function ChatBubble({ message }: { message: AffiliateChatMessage }) {
  const [expanded, setExpanded] = useState(true);
  const isLong = message.content.length > 800;

  if (message.role === 'user') {
    return (
      <div className="flex justify-end">
        <div className="flex items-start gap-2 max-w-[80%]">
          <div className="bg-blue-600 text-white rounded-2xl rounded-tr-md px-4 py-3 text-sm">
            {message.content}
          </div>
          <div className="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center shrink-0">
            <User className="w-4 h-4 text-blue-600" />
          </div>
        </div>
      </div>
    );
  }

  if (message.role === 'system') {
    return (
      <div className="flex justify-center">
        <div className="flex items-center gap-2 bg-gray-100 rounded-full px-4 py-1.5 text-xs text-gray-500">
          <Activity className="w-3 h-3" />
          {message.content}
        </div>
      </div>
    );
  }

  const isThinking = message.id === 'agent-thinking';

  return (
    <div className="flex justify-start">
      <div className="flex items-start gap-2 max-w-[85%]">
        <div className={`w-8 h-8 rounded-full flex items-center justify-center shrink-0 ${isThinking ? 'bg-violet-100' : 'bg-green-100'}`}>
          <Bot className={`w-4 h-4 ${isThinking ? 'text-violet-600' : 'text-green-600'}`} />
        </div>
        <div className={`rounded-2xl rounded-tl-md px-4 py-3 text-sm ${isThinking ? 'bg-violet-50 border border-violet-200' : 'bg-gray-100 border border-gray-200'}`}>
          {isThinking && (
            <div className="flex items-center gap-2 mb-2">
              <Loader2 className="w-3 h-3 animate-spin text-violet-500" />
              <span className="text-xs font-medium text-violet-600">
                Turno {message.turnNumber} — Agente sta pensando...
              </span>
            </div>
          )}

          {!isThinking && isLong && (
            <button
              onClick={() => setExpanded(!expanded)}
              className="flex items-center gap-1 text-xs text-blue-500 hover:text-blue-700 mb-2"
            >
              {expanded ? <ChevronUp className="w-3 h-3" /> : <ChevronDown className="w-3 h-3" />}
              {expanded ? 'Comprimi' : 'Espandi risultato'}
            </button>
          )}

          <div className={`whitespace-pre-wrap break-words leading-relaxed ${!expanded && isLong ? 'max-h-[200px] overflow-hidden relative' : ''}`}>
            {message.content}
            {!expanded && isLong && (
              <div className="absolute bottom-0 left-0 right-0 h-16 bg-gradient-to-t from-gray-100 to-transparent" />
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

// =====================================================
// EMPTY STATE (with quick template access)
// =====================================================

function EmptyState({ onSelectTemplate }: { onSelectTemplate: (t: AffiliatePromptTemplate) => void }) {
  const quickTemplates = AFFILIATE_PROMPT_TEMPLATES.slice(0, 4);

  return (
    <div className="flex-1 flex items-center justify-center h-full min-h-[400px]">
      <div className="text-center max-w-lg">
        <div className="w-16 h-16 bg-blue-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
          <MessageSquare className="w-8 h-8 text-blue-500" />
        </div>
        <h3 className="text-lg font-semibold text-gray-900 mb-2">Affiliate Browser Chat</h3>
        <p className="text-sm text-gray-500 mb-6">
          Dai un prompt all&apos;agente browser e lui navighera il web per te.
          Puo analizzare funnel, scrapare la Facebook Ad Library, monitorare trend e molto altro.
        </p>

        {/* Quick templates */}
        <div className="space-y-2 text-left">
          <p className="text-xs font-medium text-gray-400 uppercase tracking-wide px-1">Template rapidi</p>
          {quickTemplates.map((t) => (
            <button
              key={t.id}
              onClick={() => onSelectTemplate(t)}
              className="flex items-start gap-3 p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-blue-50 hover:border-blue-200 transition-all w-full text-left group"
            >
              <div className="w-8 h-8 rounded-lg bg-white border border-gray-200 flex items-center justify-center shrink-0 group-hover:border-blue-200">
                {getCategoryIcon(t.category)}
              </div>
              <div>
                <span className="text-xs font-medium text-gray-700 group-hover:text-blue-700">{t.title}</span>
                <p className="text-[10px] text-gray-400 mt-0.5 line-clamp-1">{t.description}</p>
              </div>
            </button>
          ))}
        </div>

        <div className="mt-4 pt-4 border-t border-gray-100">
          <p className="text-xs text-gray-400 mb-2">Dopo aver ottenuto un risultato, scrivi:</p>
          <div className="flex gap-2 justify-center">
            <span className="px-2.5 py-1 bg-emerald-50 text-emerald-600 rounded-md text-xs font-medium">Salva Quiz</span>
            <span className="px-2.5 py-1 bg-violet-50 text-violet-600 rounded-md text-xs font-medium">Salva Funnel</span>
          </div>
          <p className="text-xs text-gray-400 mt-1">per salvare il risultato nel database con classificazione AI</p>
        </div>
      </div>
    </div>
  );
}
